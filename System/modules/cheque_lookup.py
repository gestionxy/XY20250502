import streamlit as st
import pandas as pd
from modules.data_loader import load_supplier_data


def cheque_lookup_query():
    """æ”¯ç¥¨å·æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒæ•°å­—å’Œæ–‡æœ¬æ”¯ç¥¨å·æ’åºï¼Œæ¨¡ç³ŠæŸ¥è¯¢ï¼Œä»¥åŠéƒ¨é—¨æ±‡æ€»å’Œè¯¦ç»†å‘ç¥¨ä¿¡æ¯æ˜¾ç¤ºã€‚"""
    # 1. è¯»å–ä¾›åº”å•†æ•°æ®
    df = load_supplier_data()

    # 2. æ˜¾ç¤ºæŸ¥è¯¢é¡µé¢æ ‡é¢˜
    st.subheader("ğŸ” æ”¯ç¥¨å·æŸ¥è¯¢")

    # 3. æå–æ‰€æœ‰éç©ºæ”¯ç¥¨å·
    # - dropna()ï¼šç§»é™¤ç¼ºå¤±å€¼ï¼Œç¡®ä¿æ²¡æœ‰ NaN æ”¯ç¥¨å·
    # - str.strip()ï¼šå»æ‰å‰åç©ºæ ¼ï¼Œé¿å…å› ç©ºæ ¼å¯¼è‡´çš„æŸ¥è¯¢å¤±è´¥
    # - unique()ï¼šè·å–å”¯ä¸€æ”¯ç¥¨å·åˆ—è¡¨ï¼Œé¿å…é‡å¤
    all_cheques = df['ä»˜æ¬¾æ”¯ç¥¨å·'].dropna()
    all_cheques = all_cheques[all_cheques.astype(str).str.strip() != ''].astype(str).unique()

    # 4. æ”¯ç¥¨å·æ’åºï¼šæ•°å­—åœ¨å‰ï¼Œæ–‡æœ¬åœ¨å
    # - ä½¿ç”¨ isnumeric() åˆ¤æ–­æ˜¯å¦ä¸ºçº¯æ•°å­—
    # - æ•°å­—æŒ‰æ•°å€¼æ’åºï¼Œæ–‡æœ¬æŒ‰å­—æ¯æ’åº
    # - c æ˜¯ all_cheques åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆå³ä¸€ä¸ªæ”¯ç¥¨å·ï¼‰ï¼Œisnumeric() æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åªåŒ…å«æ•°å­—ï¼ˆä¸åŒ…å«è´Ÿå·ã€å°æ•°ç‚¹æˆ–å…¶ä»–å­—ç¬¦ï¼‰
    # - key æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œç”¨äºå®šä¹‰æ’åºçš„è§„åˆ™
    # - key=lambda x: int(x)ï¼šå°†å­—ç¬¦ä¸²ç±»å‹çš„æ”¯ç¥¨å·å…ˆè½¬æ¢ä¸ºæ•´æ•° (int(x))ï¼Œç„¶åå†æ’åºï¼Œç¡®ä¿æŒ‰ç…§æ•°å€¼å¤§å°æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç…§å­—ç¬¦ä¸²çš„å­—å…¸é¡ºåº
    # - sorted(iterable, key=None, reverse=False) 
    numeric_cheques = sorted([c for c in all_cheques if c.isnumeric()], key=lambda x: int(x))
    text_cheques = sorted([c for c in all_cheques if not c.isnumeric()])
    sorted_cheques = numeric_cheques + text_cheques

    # 5. åˆ›å»ºä¸‹æ‹‰è¾“å…¥æ¡†
    # - optionsï¼šæ”¯æŒç©ºé€‰é¡¹ï¼ˆå³æ²¡æœ‰è¾“å…¥æ”¯ç¥¨å·ï¼‰
    # - placeholderï¼šæç¤ºç”¨æˆ·è¾“å…¥æ”¯ç¥¨å·æˆ–é€‰æ‹©ä¸‹æ‹‰é€‰é¡¹
    cheque_input = st.selectbox(
        "è¯·è¾“å…¥æˆ–é€‰æ‹©æ”¯ç¥¨å·ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰:",
        # å¦‚æœä¸è®¾ç½® [""]ï¼Œselectbox ä¼šé»˜è®¤é€‰ä¸­ sorted_cheques åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ”¯ç¥¨å·ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´è¯¯æŸ¥è¯¢
        # å¤§å¤šæ•°ç”¨æˆ·åœ¨æœç´¢æ—¶ä¼šå¸Œæœ›å…ˆæ¸…ç©ºè¾“å…¥æ¡†ï¼Œç„¶åæ‰‹åŠ¨è¾“å…¥å…³é”®å­—ã€‚
        #è®¾ç½® [""] å¯ä»¥æ¨¡æ‹Ÿè¿™ç§è‡ªç„¶çš„è¾“å…¥æµç¨‹ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚
        options=[""] + sorted_cheques,  # åŒ…å«ç©ºé€‰é¡¹
        # index æ˜¯ st.selectbox() çš„ä¸€ä¸ªå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šåœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é»˜è®¤é€‰ä¸­çš„é€‰é¡¹ç´¢å¼•
        # å› ä¸ºæˆ‘ä»¬ä¹‹å‰å·²ç»è®¾ç½®äº†options=[""]ï¼Œ å› æ­¤ index=0 åˆ™é»˜è®¤é€‰ä¸­ç©ºé€‰é¡¹ ""ï¼Œè®©ç”¨æˆ·å¯ä»¥ä»ç©ºçŠ¶æ€å¼€å§‹è¿›è¡Œæ”¯ç¥¨å·é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥
        index=0,
        # placeholder æ˜¯ä¸€ä¸ªå¯é€‰æç¤ºæ–‡æœ¬ï¼Œåœ¨ç”¨æˆ·æ²¡æœ‰è¿›è¡Œé€‰æ‹©æˆ–è¾“å…¥ä¹‹å‰æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸­çš„ç°è‰²æç¤ºä¿¡æ¯ã€‚
        placeholder="è¾“å…¥æ”¯ç¥¨å·æˆ–é€‰æ‹©ä¸‹æ‹‰é€‰é¡¹"
    )

    # 6. å¦‚æœç”¨æˆ·é€‰æ‹©äº†æ”¯ç¥¨å·æˆ–è¾“å…¥äº†æœ‰æ•ˆæ”¯ç¥¨å·
    if cheque_input:
        import re  # å¼•å…¥æ­£åˆ™è¡¨è¾¾å¼åº“ï¼Œå¤„ç†å¤æ‚å­—ç¬¦ä¸²åŒ¹é…
        # **6.1 å»æ‰å‰åç©ºæ ¼å¹¶å¤„ç†æ­£åˆ™ç‰¹æ®Šå­—ç¬¦**
        cheque_input = cheque_input.strip()  # å»æ‰å‰åç©ºæ ¼
        pattern = re.escape(cheque_input)   # è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿ç‰¹æ®Šç¬¦å·ä¸ä¼šè¢«è¯¯è§£é‡Š

        # **6.2 æ‰§è¡Œæ¨¡ç³ŠåŒ¹é…**
        # - contains() è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ï¼Œå¿½ç•¥å¤§å°å†™
        # - na=False ç¡®ä¿ NaN ä¸ä¼šå‚ä¸åŒ¹é…
        filtered = df[df['ä»˜æ¬¾æ”¯ç¥¨å·'].astype(str).str.contains(pattern, case=False, na=False)]

        # 7. æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°åŒ¹é…ç»“æœ
        if filtered.empty:
            # å¦‚æœæ²¡æœ‰åŒ¹é…ç»“æœï¼Œæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            st.warning("âŒ æ”¯ç¥¨å·ä¸å­˜åœ¨æˆ–è¾“å…¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•ã€‚")
        else:
            # 8. å·®é¢è®¡ç®—
            # - è½¬æ¢é‡‘é¢åˆ—ä¸ºæ•°å€¼ç±»å‹ï¼Œéæ•°å€¼ï¼ˆå¦‚ç©ºå€¼ï¼‰ç”¨ 0 å¡«å……
            filtered['å‘ç¥¨é‡‘é¢'] = pd.to_numeric(filtered['å‘ç¥¨é‡‘é¢'], errors='coerce').fillna(0)
            filtered['å®é™…æ”¯ä»˜é‡‘é¢'] = pd.to_numeric(filtered['å®é™…æ”¯ä»˜é‡‘é¢'], errors='coerce').fillna(0)
            filtered['å·®é¢'] = filtered['å‘ç¥¨é‡‘é¢'] - filtered['å®é™…æ”¯ä»˜é‡‘é¢']

            # 9. æ ¼å¼åŒ–æ—¥æœŸåˆ—
            # - è½¬æ¢æ—¥æœŸåˆ—ä¸ºç»Ÿä¸€æ ¼å¼ï¼Œé¿å…æ—¥æœŸæ˜¾ç¤ºé”™è¯¯
            filtered['å‘ç¥¨æ—¥æœŸ'] = pd.to_datetime(filtered['å‘ç¥¨æ—¥æœŸ'], errors='coerce').dt.strftime('%Y-%m-%d')
            # errors='coerce'ï¼š å¼ºåˆ¶è½¬æ¢ï¼šå¦‚æœæŸä¸ªå€¼æ— æ³•è½¬æ¢ä¸ºæœ‰æ•ˆæ—¥æœŸï¼ˆä¾‹å¦‚ç©ºå­—ç¬¦ä¸²æˆ–æ ¼å¼é”™è¯¯ï¼‰ï¼Œåˆ™è‡ªåŠ¨å¡«å……ä¸º NaTï¼ˆNot a Timeï¼‰ï¼Œè€Œä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚
            # .dt.strftime('%Y-%m-%d') - æ ¼å¼åŒ–æ—¥æœŸï¼Œ è½¬æ¢åçš„æ•°æ®ç±»å‹ä¼šå˜ä¸º objectï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œè€Œä¸æ˜¯ datetime64
            filtered['å¼€æ”¯ç¥¨æ—¥æœŸ'] = pd.to_datetime(filtered['å¼€æ”¯ç¥¨æ—¥æœŸ'], errors='coerce').dt.strftime('%Y-%m-%d')

            # 10. ç”Ÿæˆéƒ¨é—¨æ±‡æ€»è¡¨
            # - æŒ‰éƒ¨é—¨æ±‡æ€»å®é™…æ”¯ä»˜é‡‘é¢ã€TPS å’Œ TVQ
            # groupby().sum() åœ¨ Pandas ä¸­çš„é»˜è®¤è¡Œä¸ºï¼Œå®ƒä¼šè‡ªåŠ¨å¿½ç•¥åˆ—ä¸­çš„ç©ºå€¼ï¼ˆNaNï¼‰ï¼Œè€Œä¸æ˜¯å°†ç»“æœç›´æ¥è®¾ä¸º NaN
            # .reset_index() å°†åˆ†ç»„åˆ—ï¼ˆéƒ¨é—¨ï¼‰ä»ç´¢å¼•è½¬æ¢ä¸ºæ™®é€šåˆ—ï¼Œä½¿å¾—ç»“æœå¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ DataFrame è¿”å›ï¼Œä¾¿äºåç»­å¤„ç†å’Œå±•ç¤º
            # æ­¤æ—¶ summary å·²ç»å˜æˆäº†ä¸€ä¸ª DataFrameï¼ŒåŒ…å«éƒ¨é—¨ã€å®é™…æ”¯ä»˜é‡‘é¢ã€TPS å’Œ TVQ çš„æ€»å’Œ
            summary = filtered.groupby('éƒ¨é—¨')[['å®é™…æ”¯ä»˜é‡‘é¢', 'TPS', 'TVQ']].sum().reset_index()
            
            # - æ·»åŠ æ€»è®¡è¡Œ
            total_row = pd.DataFrame([{
                # éƒ¨é—¨ åˆ— ä¸‹é¢æ”¾ä¸€ä¸ª æ€»è®¡
                'éƒ¨é—¨': 'æ€»è®¡',
                'å®é™…æ”¯ä»˜é‡‘é¢': summary['å®é™…æ”¯ä»˜é‡‘é¢'].sum(),
                'TPS': summary['TPS'].sum(),
                'TVQ': summary['TVQ'].sum()
            }])
            
            # axis=0ï¼ˆé»˜è®¤ï¼‰ï¼šçºµå‘åˆå¹¶ï¼ˆè¡Œæ–¹å‘ï¼‰, axis=1ï¼šæ¨ªå‘åˆå¹¶ï¼ˆåˆ—æ–¹å‘ï¼‰
            # ignore_index=True ä¼šé‡æ–°è®¾ç½®ç´¢å¼•ï¼Œè€Œä¸æ˜¯ä¿ç•™åŸæœ‰ç´¢å¼•
            summary = pd.concat([summary, total_row], axis = 0, ignore_index=True)

            # **10.1 å®šä¹‰æ€»è®¡è¡Œé«˜äº®å‡½æ•°**
            def highlight_total(row):
                # å½“å‰è¡Œæ˜¯å¦æ˜¯â€œæ€»è®¡â€è¡Œï¼Œè®¾ç½®èƒŒæ™¯é¢œè‰²
                if row['éƒ¨é—¨'] == 'æ€»è®¡':
                    # len(row)ï¼šè·å–å½“å‰è¡Œçš„åˆ—æ•°
                    return ['background-color: #FADBD8'] * len(row)
                # å¦‚æœä¸æ˜¯â€œæ€»è®¡â€è¡Œï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºæ ·å¼åˆ—è¡¨ï¼Œä¸åšä»»ä½•æ ·å¼è®¾ç½®ã€‚
                return [''] * len(row)

            # 11. æ˜¾ç¤ºéƒ¨é—¨æ±‡æ€»ç»“æœ
            st.markdown("### ğŸ’° æŸ¥è¯¢ç»“æœï¼šéƒ¨é—¨æ±‡æ€»")
            st.dataframe(
                summary.style
                # åœ¨ Pandas çš„ DataFrame.apply() æ–¹æ³•ä¸­ï¼Œå‡½æ•°**highlight_totalçš„è°ƒç”¨æ–¹å¼ä¸æ™®é€š Python å‡½æ•°æœ‰æ‰€ä¸åŒ,ä¸éœ€è¦()æ˜¾å¼ä¼ é€’å‚æ•°,
                # ä¸»è¦åŸå› æ˜¯åœ¨ apply() ä¼ é€’å‡½æ•°æ—¶ï¼ŒPandas ä¼šè‡ªåŠ¨å°†æ¯ä¸€è¡Œï¼ˆaxis=1ï¼‰æˆ–æ¯ä¸€åˆ—ï¼ˆaxis=0ï¼‰ä½œä¸º**Seriesä¼ é€’ç»™å‡½æ•°ï¼Œå› æ­¤highlight_total**ä¸éœ€è¦æ˜¾å¼ä¼ é€’å‚æ•°ã€‚
                # highlight_total(row) åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³**row**
                .apply(highlight_total, axis=1) # axis=1 æŒ‰è¡Œåº”ç”¨æ ·å¼
                .format({
                    # ï¼šæ ¼å¼è¯´æ˜ç¬¦å¼€å§‹   , å¯ç”¨åƒåˆ†ä½    .2f ä¿ç•™ä¸¤ä½å°æ•°
                    'å®é™…æ”¯ä»˜é‡‘é¢': '{:,.2f}',
                    'TPS': '{:,.2f}',
                    'TVQ': '{:,.2f}'
                }),
                use_container_width=True
            )

            # 12. æ˜¾ç¤ºè¯¦ç»†å‘ç¥¨ä¿¡æ¯
            st.markdown("### ğŸ§¾ æŸ¥è¯¢ç»“æœï¼šè¯¦ç»†å‘ç¥¨ä¿¡æ¯")
            st.dataframe(
                filtered[['éƒ¨é—¨', 'å…¬å¸åç§°', 'å‘ç¥¨å·', 'å‘ç¥¨é‡‘é¢', 'å®é™…æ”¯ä»˜é‡‘é¢', 'TPS', 'TVQ', 'å·®é¢', 'å‘ç¥¨æ—¥æœŸ', 'å¼€æ”¯ç¥¨æ—¥æœŸ']]
                .style.format({
                    'å‘ç¥¨é‡‘é¢': '{:,.2f}',
                    'å®é™…æ”¯ä»˜é‡‘é¢': '{:,.2f}',
                    'TPS': '{:,.2f}',
                    'TVQ': '{:,.2f}',
                    'å·®é¢': '{:,.2f}'
                }),
                use_container_width=True
            )
