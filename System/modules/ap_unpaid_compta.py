import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from datetime import timedelta
import numpy as np

from ui.sidebar import get_selected_departments
from modules.data_loader import load_supplier_data



def style_dataframe(df):
    def highlight_rows(row):
        if isinstance(row['éƒ¨é—¨'], str):
            if row['éƒ¨é—¨'].endswith("æ±‡æ€»"):
                return ['background-color: #E8F6F3'] * len(row)
            elif row['éƒ¨é—¨'] == 'æ€»è®¡':
                return ['background-color: #FADBD8'] * len(row)
        return [''] * len(row)
    return df.style.apply(highlight_rows, axis=1).format({
        'å‘ç¥¨é‡‘é¢': "{:,.2f}",
        'å®é™…æ”¯ä»˜é‡‘é¢': "{:,.2f}",
        'åº”ä»˜æœªä»˜å·®é¢': "{:,.2f}",
        'TPS': "{:,.2f}",
        'TVQ': "{:,.2f}",
        'Hors Taxes': "{:,.2f}",
   
    })

# æ­¤ç‰ˆæœ¬ä¸“ç”¨äºä¼šè®¡åšè´¦ä½¿ç”¨ï¼Œä»¥å‘ç¥¨æ—¥æœŸä¸ºå‡†ï¼Œæˆªæ­¢æ—¥æœŸä»¥é“¶è¡Œå¯¹è´¦æ—¥æœŸä¸ºå‡†ï¼Œç”±æ­¤è®¡ç®—æ˜¯åœ¨è¿™æ®µæ—¶é—´å†…å®Œæˆä»˜æ¬¾ï¼Œæœªå®Œæˆçš„æŒ‰ åº”ä»˜æœªä»˜è¿›è¡Œå¤„ç†
def ap_unpaid_query_compta():


    # 0. åŠ è½½åº”ä»˜è´¦æ¬¾æ•°æ®
    # 1. æ ‡å‡†åŒ–å…³é”®æ—¥æœŸåˆ—ä¸º datetime æ ¼å¼ï¼ˆå¦‚å¼€æ”¯ç¥¨æ—¥æœŸã€å‘ç¥¨æ—¥æœŸç­‰ï¼‰
    # 2. å®šä¹‰é€šç”¨çš„â€œé“¶è¡Œå¯¹è´¦æ—¥æœŸâ€è®¡ç®—é€»è¾‘ï¼š
    #  - æ¯æœˆ25æ—¥ï½æ¬¡æœˆ24æ—¥ â†’ å¯¹è´¦æ—¥æœŸç»Ÿä¸€è®¾ä¸ºæ¬¡æœˆ1æ—¥ï¼ˆå¦‚ï¼š2024-08-25ï½09-24 â†’ 2024-09-01ï¼‰   
    
    # é˜¶æ®µä¸€ï¼šç›®æ ‡å…¬å¸å¤„ç†é€»è¾‘
    #3. è¯†åˆ«å±äºç›®æ ‡å…¬å¸åˆ—è¡¨çš„æ‰€æœ‰è¡Œï¼ˆå¦‚ SERVICELAB, Wah Teng ç­‰ï¼‰
    #4. å¯¹äºè¿™äº›è¡Œï¼š
            #- å¦‚æœå­˜åœ¨â€œå¼€æ”¯ç¥¨æ—¥æœŸâ€ â†’ è®¾ä¸ºâ€œé“¶è¡Œè¿‡è´¦æ—¥æœŸâ€
            # - å¦åˆ™ â†’ â€œé“¶è¡Œè¿‡è´¦æ—¥æœŸâ€ = å‘ç¥¨æ—¥æœŸ + 10 å¤©

    #5. æ ¹æ®é“¶è¡Œè¿‡è´¦æ—¥æœŸåŠ¨æ€ç”Ÿæˆé“¶è¡Œå¯¹è´¦æ—¥æœŸï¼š
            #- ä½¿ç”¨å‰é¢å®šä¹‰çš„å‘¨æœŸé€»è¾‘å‡½æ•°


    # é˜¶æ®µäºŒï¼šå¼‚å¸¸è®°å½•ï¼ˆå­—æ¯å¼€å¤´æ”¯ç¥¨å· + æ— é“¶è¡Œè¿‡è´¦æ—¥æœŸï¼‰
    # 6. ç­›é€‰æ‰€æœ‰æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„è¡Œï¼š
            # - é“¶è¡Œè¿‡è´¦æ—¥æœŸä¸ºç©º
            #- ä»˜æ¬¾æ”¯ç¥¨å·æ˜¯å­—æ¯å¼€å¤´ï¼ˆå¦‚ï¼šETF-Alexã€VISA-cielï¼‰

    # 7. å¯¹äºè¿™äº›è¡Œï¼š
            #- å¦‚æœå­˜åœ¨â€œå¼€æ”¯ç¥¨æ—¥æœŸâ€ â†’ è®¾ä¸ºé“¶è¡Œè¿‡è´¦æ—¥æœŸ
            #- å¦åˆ™ â†’ é“¶è¡Œè¿‡è´¦æ—¥æœŸ = å‘ç¥¨æ—¥æœŸ + 10å¤©

    # 8. å†æ¬¡å¥—ç”¨é€šç”¨å¯¹è´¦æ—¥æœŸå‡½æ•°ï¼Œç”Ÿæˆè§„èŒƒçš„é“¶è¡Œå¯¹è´¦æ—¥æœŸ


    # -------------------------------
    # 1. è½½å…¥æ•°æ®
    # -------------------------------
    df = load_supplier_data()

    # å› ä¸ºä¼šè®¡åšè´¦ï¼Œæœ¬æ¬¡è¿›å¤„ç†é‡‡è´­ç±» purchase çš„é¡¹ç›®ï¼Œå› æ­¤ä»…ç­›é€‰ä¿ç•™å¦‚ä¸‹ éƒ¨é—¨é¡¹ç›®
    selected_departments = ['å†»éƒ¨', 'å¨æˆ¿', 'æ‚è´§', 'ç‰›å¥¶ç”Ÿé²œ', 'è‚‰éƒ¨', 'èœéƒ¨', 'è¿è¾“', 'é…’æ°´', 'é±¼éƒ¨']
    df = df[df['éƒ¨é—¨'].isin(selected_departments)].reset_index(drop=True)
        
    # 1.1 é¦–å…ˆæ’é™¤å‡º ç›´æ¥ç”¨ä¿¡ç”¨å¡VISA-1826 è¿›è¡Œæ”¯ä»˜çš„ï¼Œä¿¡ç”¨å¡æ”¯ä»˜çš„ä¸æ˜¯å…¬å¸æ”¯ç¥¨è´¦æˆ·
    df = df[~df['å…¬å¸åç§°'].isin(['SLEEMAN', 'Arc-en-ciel','Ferme vallee verte'])]

    # -------------------------------
    # 2. æ—¥æœŸå­—æ®µè½¬æ¢ä¸º datetime ç±»å‹ï¼ˆä¸€æ¬¡æ€§ï¼‰
    # -------------------------------
    df['å¼€æ”¯ç¥¨æ—¥æœŸ'] = pd.to_datetime(df['å¼€æ”¯ç¥¨æ—¥æœŸ'], errors='coerce')
    df['å‘ç¥¨æ—¥æœŸ'] = pd.to_datetime(df['å‘ç¥¨æ—¥æœŸ'], errors='coerce')
    df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = pd.to_datetime(df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'], errors='coerce')

    # -------------------------------
    # 3. å®šä¹‰é“¶è¡Œå¯¹è´¦æ—¥æœŸè®¡ç®—å‡½æ•°ï¼ˆé€šç”¨ï¼‰
    # -------------------------------
    def calculate_reconcile_date(posting_date: pd.Timestamp) -> pd.Timestamp:
        if pd.isna(posting_date):
            return pd.NaT
        if posting_date.day >= 25:
            month = (posting_date.month % 12) + 1
            year = posting_date.year if posting_date.month < 12 else posting_date.year + 1
        else:
            month = posting_date.month
            year = posting_date.year
        return pd.Timestamp(f"{year}-{month:02d}-01")

    # -------------------------------
    # ç¬¬ä¸€éƒ¨åˆ†ï¼šå¤„ç†ç›®æ ‡å…¬å¸åˆ—è¡¨
    # -------------------------------
    # ç›®æ ‡å…¬å¸ä¸ºä½¿ç”¨ PPA/DEBITç­‰ æ‰£æ¬¾æ–¹å¼ï¼Œæˆ‘ä»¬é»˜è®¤ä¸ºä½¿ç”¨ å‘ç¥¨æ—¥æœŸ+10 == é“¶è¡Œå¯¹è´¦æ—¥æœŸ
    target_companies = [
        'SERVICELAB',
        'Wah Teng',
        'Saputo',
        'Monco',
        'ALEX COULOMBE',
        'Canada Bread',
        'CANADAWIDE FRUIT',
        'Beaudry & Cadrin Inc',
        'Bimbo',
        'IMPERIAL TOBACCO CANADA',
        'BOULANGERIE BLOUIN',
        'korsmet'
    ]

    mask_target = df['å…¬å¸åç§°'].isin(target_companies)

    # é“¶è¡Œè¿‡è´¦æ—¥æœŸå¡«è¡¥ï¼ˆç›®æ ‡å…¬å¸ï¼‰ é“¶è¡Œã€è¿‡è´¦ã€‘æ—¥æœŸ ä¸º ç³»ç»Ÿè‡ªåŠ¨åŠ å…¥çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®¡ç®— é“¶è¡Œå¯¹è´¦æ—¥æœŸï¼ˆé“¶è¡Œå•å­ï¼‰
    df.loc[mask_target, 'é“¶è¡Œè¿‡è´¦æ—¥æœŸ'] = np.where(
        df.loc[mask_target, 'å¼€æ”¯ç¥¨æ—¥æœŸ'].notna(),
        df.loc[mask_target, 'å¼€æ”¯ç¥¨æ—¥æœŸ'],
        df.loc[mask_target, 'å‘ç¥¨æ—¥æœŸ'] + pd.to_timedelta(10, unit='d')
    )

    # é“¶è¡Œå¯¹è´¦æ—¥æœŸæ›´æ–°ï¼ˆç›®æ ‡å…¬å¸ï¼‰
    df.loc[mask_target, 'é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = df.loc[mask_target, 'é“¶è¡Œè¿‡è´¦æ—¥æœŸ'].apply(calculate_reconcile_date)
    

    # -------------------------------
   # -------------------------------
    # ç¬¬äºŒéƒ¨åˆ†ï¼šå¤„ç†â€œé“¶è¡Œè¿‡è´¦æ—¥æœŸä¸ºç©º ä¸” æ”¯ç¥¨å·ä¸ºå­—æ¯å¼€å¤´â€çš„è®°å½•ï¼ˆæ’é™¤ NaN å’Œç©ºå­—ç¬¦ä¸²ï¼‰
    # -------------------------------

    # æ¡ä»¶ 1ï¼šã€é“¶è¡Œè¿‡è´¦ã€‘æ—¥æœŸä¸ºç©º
    mask_null_posting = df['é“¶è¡Œè¿‡è´¦æ—¥æœŸ'].isna()

    # æ¡ä»¶ 2ï¼šã€ä»˜æ¬¾æ”¯ç¥¨å·ã€‘éç©ºã€é'nan'æ–‡æœ¬ã€éç©ºæ ¼ï¼Œå¹¶ä»¥è‹±æ–‡å­—æ¯å¼€å¤´
    #      å…¬å¸åç§°	        éƒ¨é—¨	 å‘ç¥¨å·	  å‘ç¥¨æ—¥æœŸ	  å‘ç¥¨é‡‘é¢	TPS	    TVQ	   ç¨åå‡€å€¼	ä»˜æ¬¾æ”¯ç¥¨å·	å®é™…æ”¯ä»˜é‡‘é¢	ä»˜æ¬¾æ”¯ç¥¨æ€»é¢	å¼€æ”¯ç¥¨æ—¥æœŸ	  æ”¯ç¥¨å¯„å‡ºæ—¥æœŸ	é“¶è¡Œå¯¹è´¦æ—¥æœŸ
    # Beaudry & Cadrin Inc	é…’æ°´	6031806	2024-10-07	4143.49	180.01	359.06	3604.42	PPA-Beaudry	4143.49	        4143.49	      2024-10-30		          ??????
    # å¯¹äºè¿™æ ·çš„æƒ…å†µï¼ŒPPA-Beaudry ä½†æ²¡æœ‰å…·æœ‰çš„é“¶è¡Œè¿‡è´¦æ—¥æœŸï¼Œæˆ‘ä»¬è¦è®¡ç®— é“¶è¡Œå¯¹è´¦æ—¥æœŸï¼Œ å› æ­¤æˆ‘ä»¬è®¾ç½®æ¡ä»¶ å‘ç¥¨æ—¥æœŸ + 10 å¤©

    mask_letter_cheque = (
        df['ä»˜æ¬¾æ”¯ç¥¨å·'].notna() &  # ä¸æ˜¯å®é™… NaNï¼ˆnp.nanï¼‰
        df['ä»˜æ¬¾æ”¯ç¥¨å·'].astype(str).str.strip().str.lower().ne('nan') &  # æ’é™¤ 'nan' å­—ç¬¦ä¸²
        df['ä»˜æ¬¾æ”¯ç¥¨å·'].astype(str).str.strip().ne('') &  # æ’é™¤ç©ºå­—ç¬¦ä¸²
        df['ä»˜æ¬¾æ”¯ç¥¨å·'].astype(str).str.match(r'^[A-Za-z]')  # ç¡®ä¿ä»¥è‹±æ–‡å­—æ¯å¼€å¤´
    )

    # ç»¼åˆæ¡ä»¶
    mask_letter_cheque_null_posting = mask_null_posting & mask_letter_cheque

    # é“¶è¡Œè¿‡è´¦æ—¥æœŸå¡«è¡¥ï¼šä¼˜å…ˆä½¿ç”¨å¼€æ”¯ç¥¨æ—¥æœŸï¼Œå¦åˆ™ä¸ºå‘ç¥¨æ—¥æœŸ + 10 å¤©
    df.loc[mask_letter_cheque_null_posting, 'é“¶è¡Œè¿‡è´¦æ—¥æœŸ'] = np.where(
        df.loc[mask_letter_cheque_null_posting, 'å¼€æ”¯ç¥¨æ—¥æœŸ'].notna(),
        df.loc[mask_letter_cheque_null_posting, 'å¼€æ”¯ç¥¨æ—¥æœŸ'],
        df.loc[mask_letter_cheque_null_posting, 'å‘ç¥¨æ—¥æœŸ'] + pd.to_timedelta(10, unit='d')
    )

    # é“¶è¡Œå¯¹è´¦æ—¥æœŸç”Ÿæˆï¼šæ ¹æ®é“¶è¡Œè¿‡è´¦æ—¥æœŸï¼Œåº”ç”¨å‘¨æœŸå½’æ•´é€»è¾‘
    df.loc[mask_letter_cheque_null_posting, 'é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = (
        df.loc[mask_letter_cheque_null_posting, 'é“¶è¡Œè¿‡è´¦æ—¥æœŸ']
        .apply(calculate_reconcile_date)
    )
    
    #st.info("##### ğŸ’¡ xxxxï¼ˆä¼šè®¡ç‰ˆï¼‰")
    st.dataframe(style_dataframe(df), use_container_width=True)



    # åœ¨æ­¤å¤„è¿›è¡Œæ•°æ®æ•°æ®èµ‹å€¼ï¼Œå› ä¸ºæ˜¯ ä¼šè®¡åšè´¦ä½¿ç”¨ï¼Œå› æ­¤ æˆ‘ä»¬æŒ‰ç…§ å‘ç¥¨æ—¥æœŸ å’Œ é“¶è¡Œå¯¹è´¦æ—¥æœŸ è¿›è¡Œæ“ä½œ
    # é¦–å…ˆè§„èŒƒ df é“¶è¡Œå¯¹è´¦æ—¥æœŸ çš„æ—¶é—´æ ¼å¼ï¼Œæ–¹ä¾¿ä¹‹åè¿›è¡Œæ“ä½œ
    #df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = pd.to_datetime(df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'], errors='coerce')  # ä¿æŒä¸º datetime ç±»å‹ä»¥ä¾¿åç»­æå–å¹´æœˆ


    # å‡è®¾ df æ˜¯åŸå§‹å‘ç¥¨æ•°æ®ï¼ŒåŒ…æ‹¬ä»¥ä¸‹åˆ—ï¼š
    # å‘ç¥¨æ—¥æœŸã€å‘ç¥¨é‡‘é¢ã€å®é™…æ”¯ä»˜é‡‘é¢ã€é“¶è¡Œå¯¹è´¦æ—¥æœŸã€éƒ¨é—¨ç­‰

    # ========= [1] ä¾§è¾¹æ é€‰æ‹©æ¡ä»¶ =========
    st.sidebar.subheader("ç­›é€‰æ¡ä»¶")

    # è‡ªåŠ¨è·å–å‘ç¥¨æ—¥æœŸèŒƒå›´ï¼Œä¾¿äºç”¨æˆ·é€‰æ‹©
    min_date, max_date = df['å‘ç¥¨æ—¥æœŸ'].min(), df['å‘ç¥¨æ—¥æœŸ'].max()
    start_date = st.sidebar.date_input("å¼€å§‹æ—¥æœŸ", value=min_date)
    end_date = st.sidebar.date_input("ç»“æŸæ—¥æœŸ", value=max_date)

    # ç”¨æˆ·ç­›é€‰éƒ¨é—¨ï¼ˆä¾‹å¦‚ ["è‚‰éƒ¨", "è”¬èœ", "é…’æ°´"]ï¼‰
    departments = get_selected_departments(df)

    # ========= [2] ç­›é€‰å‘ç¥¨æ—¥æœŸåœ¨èŒƒå›´å†…çš„è®°å½• =========
    # ä¾‹å¦‚ï¼šåªä¿ç•™å‘ç¥¨æ—¥æœŸåœ¨ 2024-03-01 è‡³ 2024-04-30 ä¹‹é—´çš„è®°å½•
    mask_invoice_range = (
        df['å‘ç¥¨æ—¥æœŸ'] >= pd.to_datetime(start_date)
    ) & (
        df['å‘ç¥¨æ—¥æœŸ'] <= pd.to_datetime(end_date)
    )



    # é“¶è¡Œå¯¹è´¦æ—¥æœŸå­˜åœ¨ï¼ˆéç©ºï¼‰
    mask_bank_date_exists = df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'].notna()

    # é“¶è¡Œå¯¹è´¦æ—¥æœŸä¸åœ¨å‘ç¥¨æ—¥æœŸèŒƒå›´å†…
    mask_bank_not_in_range = (
        (df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] >= pd.to_datetime(start_date)) &
        (df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] <= pd.to_datetime(end_date))
    )

    # æœ€ç»ˆç­›é€‰ï¼šé“¶è¡Œå¯¹è´¦æ—¥æœŸå­˜åœ¨ ä¸” ä¸åœ¨å‘ç¥¨æ—¥æœŸèŒƒå›´
    mask_final = mask_bank_date_exists & mask_bank_not_in_range

    # æ›´æ–°â€œå®é™…æ”¯ä»˜é‡‘é¢â€ ä¸º å‘ç¥¨é‡‘é¢
    df.loc[mask_final, 'å®é™…æ”¯ä»˜é‡‘é¢'] = df.loc[mask_final, 'å‘ç¥¨é‡‘é¢']














    
    # æ›´æ–°â€œå®é™…æ”¯ä»˜é‡‘é¢â€ä¸ºâ€œå‘ç¥¨é‡‘é¢â€ï¼Œå‰ææ˜¯é“¶è¡Œå¯¹è´¦æ—¥æœŸåœ¨æŒ‡å®šèŒƒå›´å†…
    # å‰ä¸€æ­¥å°†Saputoã€mask_targetã€‘è¿™ä¸€ç±»çš„å…¬å¸è‡ªåŠ¨è®¾ç½®é“¶è¡Œå¯¹è´¦æ—¥æœŸï¼Œç°åœ¨è¦æ ¹æ®é“¶è¡Œå¯¹è´¦æ—¥æœŸè°ƒæ•´å…¶å®é™…æ”¯ä»˜
    # å¦‚æœé“¶è¡Œå¯¹è´¦æ—¥æœŸè½åœ¨ç”¨æˆ·é€‰å®šçš„èŒƒå›´ï¼Œåˆ™é»˜è®¤å®é™…å·²æ”¯ä»˜ï¼Œ å®é™…æ”¯ä»˜é‡‘é¢ == å‘ç¥¨é‡‘é¢
    #df.loc[mask_target & mask_invoice_range, 'å®é™…æ”¯ä»˜é‡‘é¢'] = df.loc[mask_target & mask_invoice_range, 'å‘ç¥¨é‡‘é¢']

    
    # ç”Ÿæˆç­›é€‰ç»“æœå­é›†
    df_filtered = df[mask_invoice_range].copy()

    # ç¤ºä¾‹ï¼š
    # å‘ç¥¨å· A001 | å‘ç¥¨æ—¥æœŸ: 2024-03-10 | å‘ç¥¨é‡‘é¢: 1000 | å®é™…æ”¯ä»˜é‡‘é¢: 1000 | é“¶è¡Œå¯¹è´¦æ—¥æœŸ: 2024-03-15  âœ…
    # å‘ç¥¨å· A002 | å‘ç¥¨æ—¥æœŸ: 2024-02-15 â†’ âŒï¼ˆä¸åœ¨èŒƒå›´å†…è¢«æ’é™¤ï¼‰

    # ========= [3] æ„é€ å±è”½æ¡ä»¶ï¼Œåˆ é™¤â€œå¯¹è´¦å®Œæˆâ€çš„è®°å½• =========
    # è§„åˆ™ï¼š
    # - é“¶è¡Œå¯¹è´¦æ—¥æœŸä¸ä¸ºç©ºï¼Œä¸”ä¹Ÿåœ¨æ—¶é—´èŒƒå›´å†…
    # - å‘ç¥¨é‡‘é¢ == å®é™…æ”¯ä»˜é‡‘é¢ï¼ˆå¯¹è´¦å®Œæˆï¼‰

    mask_to_exclude = (
        df_filtered['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'].notna() &  # éç©ºè¯´æ˜å·²è¿‡è´¦
        (df_filtered['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] >= pd.to_datetime(start_date)) &
        (df_filtered['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] <= pd.to_datetime(end_date)) &
        ((df_filtered['å‘ç¥¨é‡‘é¢'] - df_filtered['å®é™…æ”¯ä»˜é‡‘é¢'].fillna(0)) == 0)
    )

    # ç¤ºä¾‹ï¼ˆå°†è¢«æ’é™¤ï¼‰ï¼š
    # å‘ç¥¨å· A003 | å‘ç¥¨é‡‘é¢: 1500 | å®é™…æ”¯ä»˜é‡‘é¢: 1500 | é“¶è¡Œå¯¹è´¦æ—¥æœŸ: 2024-03-25 âœ…ï¼ˆå®Œå…¨å¯¹è´¦ â†’ æ’é™¤ï¼‰

    # ç¤ºä¾‹ï¼ˆå°†ä¿ç•™ï¼‰ï¼š
    # å‘ç¥¨å· A004 | å‘ç¥¨é‡‘é¢: 2000 | å®é™…æ”¯ä»˜é‡‘é¢: 1500 â†’ å·®é¢ â‰  0 â†’ ä¿ç•™
    # å‘ç¥¨å· A005 | é“¶è¡Œå¯¹è´¦æ—¥æœŸä¸ºç©º â†’ å°šæœªè¿‡è´¦ â†’ ä¿ç•™

    # ========= [4] å»é™¤è¢«å±è”½çš„è®°å½•ï¼Œå¾—åˆ°æœ€ç»ˆä¿ç•™çš„ç»“æœ =========
    df = df_filtered[~mask_to_exclude].reset_index(drop=True)

    # ========= [5] å¯¹â€œå°šæœªè¿‡è´¦â€çš„è®°å½•ï¼Œå°†å…¶å®é™…æ”¯ä»˜é‡‘é¢æ¸…é›¶ =========
    # åŸå› ï¼šè¿™äº›å‘ç¥¨è™½ç„¶åœ¨èŒƒå›´å†…ï¼Œä½†è¿˜æœªå¤„ç†ï¼Œæ‰€ä»¥è§†ä¸ºâ€œå°šæœªæ”¯ä»˜â€

    mask_no_posting_date = df['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'].isna()
    df.loc[mask_no_posting_date, 'å®é™…æ”¯ä»˜é‡‘é¢'] = 0

    # ç¤ºä¾‹ï¼š
    # å‘ç¥¨å· A006 | å‘ç¥¨é‡‘é¢: 1800 | å®é™…æ”¯ä»˜é‡‘é¢: 1800 | é“¶è¡Œå¯¹è´¦æ—¥æœŸ: None â†’ å®é™…æ”¯ä»˜é‡‘é¢æ¸…é›¶ä¸º 0

    # ========= [å¯é€‰ï¼šæŒ‰éƒ¨é—¨è¿›ä¸€æ­¥è¿‡æ»¤] =========
    # å¦‚æœç”¨æˆ·é€‰æ‹©äº†ç‰¹å®šéƒ¨é—¨ï¼Œä¹Ÿå¯ç»§ç»­æŒ‰éƒ¨é—¨ç­›é€‰
    # df = df[df['éƒ¨é—¨'].isin(departments)]

    
    #st.info("##### ğŸ’¡ åº”ä»˜æœªä»˜ï¼ˆä¼šè®¡ç‰ˆï¼‰")
    #st.dataframe(style_dataframe(df), use_container_width=True)


    # âœ… åªè¿‡æ»¤æ—¶é—´ï¼Œä¸ç­›é€‰éƒ¨é—¨
    filtered_time_only = df[
        (df['å‘ç¥¨æ—¥æœŸ'] >= pd.to_datetime(start_date)) &
        (df['å‘ç¥¨æ—¥æœŸ'] <= pd.to_datetime(end_date))
    ].copy()
    
    filtered_time_only['å®é™…æ”¯ä»˜é‡‘é¢'] = filtered_time_only['å®é™…æ”¯ä»˜é‡‘é¢'].fillna(0)
    filtered_time_only['å‘ç¥¨é‡‘é¢'] = filtered_time_only['å‘ç¥¨é‡‘é¢'].fillna(0)
    filtered_time_only['åº”ä»˜æœªä»˜å·®é¢'] = filtered_time_only['å‘ç¥¨é‡‘é¢'] - filtered_time_only['å®é™…æ”¯ä»˜é‡‘é¢']

    # âœ… ç­›é€‰éƒ¨é—¨
    filtered = filtered_time_only[filtered_time_only['éƒ¨é—¨'].isin(departments)].copy()

    # âœ… éƒ¨é—¨æ±‡æ€»è¡¨
    summary_table = (
        filtered.groupby('éƒ¨é—¨')[['å‘ç¥¨é‡‘é¢', 'å®é™…æ”¯ä»˜é‡‘é¢', 'åº”ä»˜æœªä»˜å·®é¢','TPS', 'TVQ',]]
        .sum()
        .reset_index()
    )


    total_row = pd.DataFrame([{
        'éƒ¨é—¨': 'æ€»è®¡',
        'å‘ç¥¨é‡‘é¢': summary_table['å‘ç¥¨é‡‘é¢'].sum(),
        'å®é™…æ”¯ä»˜é‡‘é¢': summary_table['å®é™…æ”¯ä»˜é‡‘é¢'].sum(),
        'åº”ä»˜æœªä»˜å·®é¢': summary_table['åº”ä»˜æœªä»˜å·®é¢'].sum(),
        'TPS': summary_table['TPS'].sum(),
        'TVQ': summary_table['TVQ'].sum(),
    }])
    summary_table = pd.concat([summary_table, total_row], ignore_index=True)

    summary_table['Hors Taxes'] = summary_table['åº”ä»˜æœªä»˜å·®é¢'] - summary_table['TPS'] - summary_table['TVQ']


    st.markdown("""
    <h4 >
    ğŸ§¾ <strong>å„éƒ¨é—¨åº”ä»˜æœªä»˜è´¦å•ï¼ˆä¼šè®¡ç‰ˆï¼‰é‡‘é¢æ±‡æ€»</strong>
    </h4>
    """, unsafe_allow_html=True)
    st.info("##### ğŸ’¡ åº”ä»˜æœªä»˜ï¼ˆä¼šè®¡ç‰ˆï¼‰è´¦å•æ˜¯æŒ‰ç…§ğŸ§¾å‘ç¥¨æ—¥æœŸè¿›è¡Œç­›é€‰è®¾ç½®çš„ï¼Œå¹¶ä¸”æŒ‰ç…§ é“¶è¡Œå¯¹è´¦å•æ—¥æœŸ ä½œä¸ºå®é™…ä»˜æ¬¾æ—¥æœŸ")
    #st.markdown("<h4 style='color:#196F3D;'>ğŸ“‹ å„éƒ¨é—¨<span style='color:red;'>åº”ä»˜æœªä»˜</span>è´¦å•é‡‘é¢æ±‡æ€» </h4>", unsafe_allow_html=True)
    st.dataframe(style_dataframe(summary_table), use_container_width=True)


    # âœ… æ˜ç»†è¡¨
    # æ­¥éª¤ 1ï¼šå°†â€œå‘ç¥¨æ—¥æœŸâ€åˆ—è½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸç±»å‹ï¼ˆdatetime.dateï¼‰
    # ä½¿ç”¨ pd.to_datetime å¯è‡ªåŠ¨è¯†åˆ«å¤šç§æ ¼å¼ï¼›errors='coerce' è¡¨ç¤ºé‡åˆ°éæ³•å€¼å°†è½¬æ¢ä¸º NaTï¼ˆç©ºæ—¥æœŸï¼‰
    # å†ç”¨ .dt.date å»é™¤æ—¶é—´ä¿¡æ¯ï¼Œåªä¿ç•™æ—¥æœŸéƒ¨åˆ†ï¼ˆå¦‚ 2025-05-05ï¼‰
    df['å‘ç¥¨æ—¥æœŸ'] = pd.to_datetime(df['å‘ç¥¨æ—¥æœŸ'], errors='coerce').dt.date

    # æ­¥éª¤ 2ï¼šæ„å»ºæœ€ç»ˆå±•ç¤ºç”¨çš„ DataFrameï¼ˆæ˜ç»† + å°è®¡ + æ€»è®¡ï¼‰
    final = pd.DataFrame()  # åˆå§‹åŒ–ç©ºè¡¨æ ¼ç”¨äºåç»­æ‹¼æ¥

    # éå†æ¯ä¸ªéƒ¨é—¨ï¼Œåˆ†ç»„å¤„ç†
    for dept, df_dept in filtered.groupby('éƒ¨é—¨'):
        # å¯¹æ¯ä¸ªéƒ¨é—¨å†…çš„å…¬å¸åˆ†ç»„
        for company, df_comp in df_dept.groupby('å…¬å¸åç§°'):
            # æ‹¼æ¥å½“å‰å…¬å¸æ‰€æœ‰æ˜ç»†æ•°æ®ï¼Œåªä¿ç•™æŒ‡å®šåˆ—
            final = pd.concat([final, df_comp[['éƒ¨é—¨', 'å…¬å¸åç§°', 'å‘ç¥¨å·', 'å‘ç¥¨æ—¥æœŸ','é“¶è¡Œå¯¹è´¦æ—¥æœŸ', 'å‘ç¥¨é‡‘é¢', 'ä»˜æ¬¾æ”¯ç¥¨å·','å®é™…æ”¯ä»˜é‡‘é¢', 'åº”ä»˜æœªä»˜å·®é¢','TPS','TVQ']]])
        
        # éƒ¨é—¨å°è®¡ï¼šå¯¹å½“å‰éƒ¨é—¨çš„é‡‘é¢å­—æ®µæ±‚å’Œï¼ˆæ€»é¢ã€å°è®¡ï¼‰
        subtotal = df_dept[['å‘ç¥¨é‡‘é¢', 'å®é™…æ”¯ä»˜é‡‘é¢', 'åº”ä»˜æœªä»˜å·®é¢','TPS','TVQ']].sum().to_frame().T  # è½¬ç½®æˆä¸€è¡Œ DataFrame
        subtotal['éƒ¨é—¨'] = f"{dept} æ±‡æ€»"   # ç‰¹æ®Šæ ‡è¯†è¯¥è¡Œä¸ºâ€œXXéƒ¨é—¨ æ±‡æ€»â€
        subtotal['å…¬å¸åç§°'] = ''           # å°è®¡è¡Œæ— å…¬å¸
        subtotal['å‘ç¥¨å·'] = ''
        subtotal['ä»˜æ¬¾æ”¯ç¥¨å·'] = ''             # å°è®¡è¡Œæ— å‘ç¥¨å·
        subtotal['å‘ç¥¨æ—¥æœŸ'] = pd.NaT       # å°è®¡è¡Œä¸è®¾æ—¥æœŸï¼Œç”¨ pd.NaT ä¿æŒç±»å‹ä¸€è‡´
        subtotal['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = pd.NaT
        final = pd.concat([final, subtotal], ignore_index=True)  # æ‹¼æ¥è‡³ final è¡¨æ ¼

    # æ‰€æœ‰éƒ¨é—¨æ€»è®¡ï¼šæ±‡æ€»æ‰€æœ‰é‡‘é¢å­—æ®µ
    total = filtered[['å‘ç¥¨é‡‘é¢', 'å®é™…æ”¯ä»˜é‡‘é¢', 'åº”ä»˜æœªä»˜å·®é¢','TPS','TVQ']].sum().to_frame().T
    total['éƒ¨é—¨'] = 'æ€»è®¡'            # æ ‡è®°â€œæ€»è®¡â€è¡Œ
    total['å…¬å¸åç§°'] = ''
    total['å‘ç¥¨å·'] = ''
    total['ä»˜æ¬¾æ”¯ç¥¨å·'] = ''
    total['å‘ç¥¨æ—¥æœŸ'] = pd.NaT        # åŒæ ·ç”¨ NaT è¡¨ç¤ºâ€œæ— æ—¥æœŸâ€
    subtotal['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = pd.NaT
    final = pd.concat([final, total], ignore_index=True)

    # æ­¥éª¤ 3ï¼šæ ¼å¼åŒ–â€œå‘ç¥¨æ—¥æœŸâ€ä¸ºå­—ç¬¦ä¸²ï¼ˆyyyy-mm-ddï¼‰
    # å¿…é¡»ä½¿ç”¨ pd.notnull(d) æ¥è¿‡æ»¤æ‰ NaTï¼Œå¦åˆ™è°ƒç”¨ d.strftime ä¼šæŠ¥é”™
    # è¿™é‡Œç¡®ä¿ï¼šåªæœ‰æœ‰æ•ˆæ—¥æœŸå¯¹è±¡æ‰æ ¼å¼åŒ–ï¼Œå¦åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
    final['å‘ç¥¨æ—¥æœŸ'] = final['å‘ç¥¨æ—¥æœŸ'].apply(
        lambda d: d.strftime('%Y-%m-%d') if pd.notnull(d) else ''
    )

    # æ­¥éª¤ 4ï¼šæŒ‰æŒ‡å®šå­—æ®µé¡ºåºé‡æ–°æ’åˆ—åˆ—ï¼Œç¡®ä¿å‰ç«¯æ˜¾ç¤ºæˆ–å¯¼å‡ºä¸€è‡´
    final = final[['éƒ¨é—¨', 'å…¬å¸åç§°', 'å‘ç¥¨å·', 'å‘ç¥¨æ—¥æœŸ','é“¶è¡Œå¯¹è´¦æ—¥æœŸ', 'å‘ç¥¨é‡‘é¢','ä»˜æ¬¾æ”¯ç¥¨å·', 'å®é™…æ”¯ä»˜é‡‘é¢', 'åº”ä»˜æœªä»˜å·®é¢','TPS','TVQ']]

    final['Hors Taxes'] = final['å‘ç¥¨é‡‘é¢'] - final['TPS'].fillna(0) - final['TVQ'].fillna(0)

    # è§„èŒƒæ—¥æœŸæ ¼å¼çš„æ˜¾ç¤º å¼ºåˆ¶æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
    final['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'] = pd.to_datetime(final['é“¶è¡Œå¯¹è´¦æ—¥æœŸ'], errors='coerce').dt.strftime('%Y-%m-%d')




    st.markdown("""
    <h4 >
    ğŸ§¾ <strong>æ–°äºšè¶…å¸‚åº”ä»˜æœªä»˜ï¼ˆä¼šè®¡ç‰ˆï¼‰è´¦å•æ˜ç»†</strong>
    </h4>
    """, unsafe_allow_html=True)
    #st.markdown("<h3 style='color:#1A5276;'>ğŸ“‹ æ–°äºšè¶…å¸‚<span style='color:red;'>åº”ä»˜æœªä»˜</span>è´¦å• æ˜ç»†</h3>", unsafe_allow_html=True)
    st.dataframe(style_dataframe(final), use_container_width=True)

   